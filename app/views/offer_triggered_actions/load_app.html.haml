- @load_facebook = false
- @load_facebook_sdk = false

- @page_title = "#{t('text.instructions.title')} - #{@offer.name}"
- amount_and_currency = content_tag(:b, t('text.instructions.amount_and_currency', :amount => @currency.get_visual_reward_amount(@offer, params[:display_multiplier]), :currency => @currency.name))

.ui-joy-mask
  .ui-joy-panel#panel
    .grey-box
      .app-logo
        = image_tag @offer.get_icon_url(:source => :cloudfront, :size => '57')
      .heading= @offer.name
    .instructions
      .content
        %ul.steps
          :plain
            #{instruction_list(@offer.instructions)}
    .padit
      .reward-button.click-action
        %span= t('text.instructions.earn_currency_html', :amount_and_currency => amount_and_currency)
    #adsby
      %span#presented_by
        = t('text.instructions.presented_by', :default => 'Presented By')
      #logo

%iframe#loader{ :style => 'display: none', :height => '0', :width => '0' }

- content_for :included_javascripts do
  :javascript
    $(function($){
      var timeout,
          ctURL = #{@click_tracking_urls.first.to_json.html_safe},
          ctURLSrc = '<iframe src="'+ ctURL +'" width="1" height="1" frameborder="0" style="display:none"></iframe>';
      if (ctURL) {
        $("body").append(ctURLSrc);
      }
      $('.click-action').click(function(e) {
        var cvURL = #{@conversion_tracking_urls.first.to_json.html_safe},
            cvURLSrc = '<iframe src="'+ cvURL +'" width="1" height="1" frameborder="0" style="display:none"></iframe>';
        if (cvURL) {
          $("body").append(cvURLSrc);
        }
        var phUrl = #{@protocol_handler_url.to_json.html_safe},
            clickURL = #{@complete_instruction_url.to_json.html_safe},
            fallbackUrl = #{@fallback_url.to_json.html_safe},
            clickUrlSrc = '<iframe src="'+ clickURL +'" width="1" height="1" frameborder="0" style="display:none"></iframe>';
        if (clickURL) {
          $("body").append(clickUrlSrc);
        }
        var appversion = navigator.appVersion,
            idevice = (/iphone|ipad|ipod|itouch/gi).test(appversion),
            android = (/android/gi).test(appversion);

        if (android) {
          if (navigator.userAgent.match(/Chrome/)) {
            setTimeout(function() {
              if (!document.webkitHidden)
                window.location.href = fallbackURL;
            }, 1000);
            window.location.href = phUrl;
          } else {
            $('#loader').attr('src', phUrl);
          }
        }
        else if (idevice) {
          timeout = setTimeout(function(){
            window.location.href = fallbackUrl;
          }, 1000);
          $('#loader').attr('src', phUrl);
          window.addEventListener("pageshow", function() {
            clearTimeout(timeout);
            window.location.reload();
          });
        }
        else {
        setTimeout(function(){
          window.location.href = fallbackUrl;
          }, 1000);
        }
      });
    });
