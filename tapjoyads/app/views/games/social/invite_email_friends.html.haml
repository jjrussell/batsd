- content_for :page_head, stylesheet_link_tag('games/facebook')

%h1.titlebar Send an Email Invite
.email_invite_wrapper
  - form_tag games_social_send_email_invites_path, :id => 'invite_friends' do
    #recipients_lable Recipients
    .recipients_wrapper= text_field_tag 'recipients', @recipients, :placeholder => 'Please use comma separate multiple emails'
    .content_wrapper= text_area_tag 'content', @content, :rows => 10, :disabled => true
    %span#back_button Back
    %span#invite_button Invite

#social_dialog.dialog_wrapper.hide
  .close_dialog
    .close_button
  .dialog
    #social_dialog_content

- content_for :page_javascript do
  :plain
    var selectedFriends = [];
    var animateSpeed = "fast";
    var inviteUrl = "#{edit_games_gamer_path}";
    
    $(document).ready(function() {
      $('#invite_button').click(function(event){
        event.preventDefault();
        var rurl = $('form#invite_friends').attr('action');
        submitEmailInvitation(rurl, $('#recipients').val());
      });

      $('#back_button').click(function(event){
        document.location.href = location.protocol + '//' + location.host + inviteUrl;
      });
    });

    var submitEmailInvitation = function(rurl, recipients){
      sending();

      $.ajax({
        type: 'POST',
        url: rurl,
        cache: false,
        timeout: 35000,
        dataType: 'json',
        data: {
          recipients: recipients
        },
        success: function(d) {
          var existDiv = '', notExistDiv = '';

          if(d.success) {
            if(d.gamers.length == 1) {
              existDiv = '<div class="dialog_content">' + d.gamers.toString().replace(/\,/g, ", ") + ' has already registered, you are now following him/her.</div>';
            }else if(d.gamers.length > 1) {
              existDiv = '<div class="dialog_content">' + d.gamers.toString().replace(/\,/g, ", ") + ' have already registered, you are now following them.</div>';
            }
            if(d.non_gamers.length != 0) {
              notExistDiv = '<div class="dialog_content">Tapjoy invites have been sent to '+d.non_gamers.toString().replace(/\,/g, ", ")+'</div>';
            }
            if(d.gamers.length == 0 && d.non_gamers.length == 0){
              var error = 'Please provide an email other than yourselves';
              showErrorDialog(error);
              return;
            }

            var msg = [
              '<div class="dialog_header_wrapper"><div class="dialog_header_right"></div><div class="dialog_header_left"></div><div class="dialog_title title_2">Success!</div></div>',
              '<div style="margin: 5px;"></div>',
              existDiv,
              notExistDiv,
              '<div class="dialog_content"><div class="continue_invite"><div class="button grey dialog_button"  style="margin-bottom: 10px;">Continue</div></div></div>'
            ].join('');
            $('#social_dialog_content').parent().animate({}, animateSpeed);
            $('#social_dialog_content').html(msg);

            TJG.ui.hideSender();
            centerDialog($('#social_dialog').height(), '#social_dialog_content', '#social_dialog');

            $('.close_dialog, .continue_invite').click(function(){
              document.location.href = location.protocol + '//' + location.host + inviteUrl;
            });
          } else {
            showErrorDialog(d.error);
          }
        },
        error: function(d) {
          var error = 'There was an issue, please try again later';
          showErrorDialog(error);
        }
      });
    };
    
    var sending = function(){
      $('.close_dialog').hide();
      TJG.ui.showSender();
    }

    var showErrorDialog = function(error){
      var msg = [
        '<div class="dialog_header_wrapper"><div class="dialog_header_right"></div><div class="dialog_header_left"></div><div class="dialog_title title_2">Oops!</div></div>',
        '<div class="dialog_content">', error, '. <span id="invite_again"><a href="#">Please click here to try again.</a></span><div style="margin: 5px;"></div></div>'
      ].join('');
      $('#social_dialog_content').parent().animate({}, animateSpeed);
      $('#social_dialog_content').html(msg);

      TJG.ui.hideSender();
      centerDialog($('#social_dialog').height(), '#social_dialog_content', '#social_dialog');

      $('#invite_again, .close_dialog').click(function(event){
        event.preventDefault();
        $('#social_dialog').fadeOut();
      });
    };

    var centerDialog = function(height, dialog_content_selector, dialog_selector){
      var scrollTop = $(window).scrollTop();
      var screenHeight = $(window).height();
      TJG.utils.centerDialog(dialog_selector);
      $(dialog_selector).fadeIn(350).css({ top: scrollTop + screenHeight / 2 - height / 2 });
    };