- @page_title = "Activity log"

%h1 Activity log

- form_tag(activities_path, :method => 'get', :id => 'form') do
  = label_tag(:user)
  = text_field_tag(:user, params[:user])
  = label_tag(:object_id)
  = text_field_tag(:object_id, params[:object_id])
  = label_tag(:request_id)
  = text_field_tag(:request_id, params[:request_id])
  = submit_tag("Change")

%table#activities_table.tablesorter
  %thead
    %tr
      %th User
      %th Object
      %th Before state
      %th After state
      %th Created
      %th Controller
      %th Action
      %th Request id
  %tbody
    - @activities.each do |activity|
      %tr
        %td
          %a{:href => "javascript:setValue('user', '#{activity.user}')"}= activity.user
        %td
          #{activity.object_type}:
          %a{:href => "javascript:setValue('object_id', '#{activity.object.id}')"}
            = activity.object.name rescue "#{activity.object.id[0,6]}..."
        %td
          - activity.before_state.each do |key, value|
            - next if key == 'updated-at' || key == 'updated_at'
            %p
              #{key}:
              %b= value
        %td
          - activity.after_state.each do |key, value|
            - next if key == 'updated-at' || key == 'updated_at'
            %p
              #{key}:
              %b= value
        %td= activity.created_at.to_s(:db)
        %td= activity.controller
        %td= activity.action
        %td
          %a{:href => "javascript:setValue('request_id', '#{activity.request_id}')"}= "#{activity.request_id[0, 6]}..."

= link_to('Next &rarr;', activities_path(:object_id => params[:object_id], :user => params[:user], :request_id => params[:request_id], :next_token => @next_token), :class => 'next') if @next_token
      
- content_for :page_javascript do
  :plain
    $(function() {
      $("#activities_table").tablesorter({widgets: ['zebra'],
        sortList: [ [4, 1] ]
      });
      
      var formY = $('#form').position()['top']
      $(window).scroll(function(event) {
        
        if ($(window).scrollTop() > formY) {
          $('#form').css({position: 'fixed', top: 0})
        } else {
          $('#form').css({position: 'absolute', top: 'auto'})
        }
      });
    });
    
    function setValue(id, value) {
      $('#' + id).val(value)
    }
  
- content_for :page_styles do
  :plain
    table.tablesorter {
      margin-top: 40px;
    }
    
    h1 {
      margin-bottom: 0;
    }
    
    form {
      background: white;
      border: 1px solid black;
      padding: 3px;
      position: absolute;
    }
    
    .next {
      float: right;
    }
