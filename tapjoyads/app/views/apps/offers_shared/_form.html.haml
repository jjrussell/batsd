- featured ||= false
- form_for(@offer, :url => { :action => :update }, :html => { :method => :put, :class => 'tjform' }) do |f|
  %table
    %tbody
      %tr
        %th
          = f.label :user_enabled, featured ? 'Enable Featured Installs' : 'Enable Installs'
          #help_user_enabled.help ?
        %td
          = f.check_box :user_enabled
          = error_message_on @offer, :user_enabled
      %tr
        %th
          = f.label :bid, 'Bid'
          #help_bid.help ?
        %td
          = f.currency_field :bid, {}, :class => 'togglable'
          = error_message_on @offer, :bid
          - if Rails.env == 'development' || request.host == 'test.tapjoy.com'
            - if featured
              #percentile-info.percentile-details
                This bid will make your offer more prioritized than
                %span#percentile= "#{@offer.estimated_percentile}%" rescue 'N/A'
                of featured offers.
              #percentile-info-loading.percentile-details{ :style => 'display: none' }
                Estimating new featured placement...
              .percentile-details
                The bid is just one of many factors affecting your featured offer ranking.
            - else
              #percentile-info.percentile-details
                This bid places you above approximately
                %span#percentile= "#{@offer.estimated_percentile}%" rescue 'N/A'
                of offers on the offerwall.
              #percentile-info-loading.percentile-details{ :style => 'display: none' }
                Estimating new offerwall placement...
              .percentile-details
                The bid is just one of many factors affecting your offerwall ranking.
      - if Rails.env == 'development' || request.host == 'test.tapjoy.com'
        %tr
          %th
            = f.label :payment, 'Payment'
            #help_payment.help ?
          %td
            = f.currency_field :payment, {}, :disabled => 'disabled'
            = error_message_on @offer, :payment
            - if @offer.partner.exclusivity_level.nil?
              .premier
                Want to reduce your payment?
                = link_to 'Learn more about the Tapjoy Premier Program', premier_path, :tabindex => 97
      %tr
        %th
          Offer Name
          #help_offer_name.help ?
        %td= @offer.name
      %tr
        %th
          = f.label :daily_budget, 'Daily Install Limit'
          #help_daily.help ?
        %td
          = f.text_field :daily_budget, :class => 'togglable'
          = error_message_on @offer, :daily_budget
          #estimated_budget
            Estimated daily budget: 
            .value
      %tr
        %th
          Balance
          #help_balance.help ?
        %td
          = number_to_currency(current_partner.balance / 100.0)
          = link_to 'Add funds', add_funds_billing_path, :class => 'addfunds', :tabindex => 98
      %tr
        %th
          Tapjoy Enabled
          #help_enabled.help ?
        %td
          - if @offer.tapjoy_enabled
            .tapjoy-enabled Enabled
          - else
            .tapjoy-disabled Disabled
      - if @offer.partner.exclusivity_level
        %tr
          %th
            Tapjoy Premier
            #help_premier.help ?
          %td
            = "Member until #{@offer.partner.exclusivity_expires_on.to_s :mdy}"
      - if permitted_to?(:edit, :statz)
        = render('apps/offers_shared/admin_fields', :f => f)
      %tr
        %td{ :colspan => 2 }= f.submit 'Update'
        
- content_for :page_javascript do
  :plain
    $(function($){

      var toggleUserEnabled = function() {
        if ($('#offer_user_enabled').attr('checked')) {
          $('.togglable').attr('disabled', false);
          $('#estimated_budget').removeClass('disabled');
        } else {
          $('.togglable').attr('disabled', true);
          $('#estimated_budget').addClass('disabled');
        }
      };

      var setEstimatedBudget = function() {
        var bid = stringToNumber($('#offer_bid').val());
        var installLimit = stringToNumber($('#offer_daily_budget').val());
        budget = 'Unlimited';
        if (installLimit >= 0) {
          budget = numberToCurrency(bid * installLimit);
        }
        $('#estimated_budget .value').html(budget);
      };

      var checkMinimumPrice = function() {
        var minimumPrice = #{([ @offer.bid, @offer.min_bid ].min) / 100.0};
        var currentPrice = stringToNumber($('#offer_bid').val());
        if (currentPrice < minimumPrice) {
          currentPrice = minimumPrice;
        }
        $('#offer_bid').val(numberToCurrency(currentPrice));
        $('#offer_payment').val(numberToCurrency(currentPrice - #{@offer.partner.premier_discount/100.0}));
      };

      var updatePercentile = function() {
        $.ajax({
          data: { "bid" : $('#offer_bid').val() },
          beforeSend: function() {
            $('#percentile-info').hide();
            $('#percentile-info-loading').show();
          },
          success: function(result) {
            $('#percentile').html(result.percentile + "%");
            $('#percentile-info-loading').hide();
            $('#percentile-info').show();
            $('#percentile').effect('highlight', {}, 1500);
          },
          type: 'post',
          url: '#{percentile_app_offer_url(@app, @offer)}'
        });
      };

      toggleUserEnabled();
      $('#offer_user_enabled').change(toggleUserEnabled);

      setEstimatedBudget();
      $('#offer_bid').change(function() {
        checkMinimumPrice();
        setEstimatedBudget();
        updatePercentile();
      });

      $('#offer_daily_budget').change(function() {
        $(this).val(stringToNumber($(this).val()));
        setEstimatedBudget();
      });

      $('form').submit(function() {
        checkMinimumPrice();
      })
    });

- content_for :page_styles do
  :plain
    .addfunds {
      padding-left: 15px;
    }

    #estimated_budget.disabled {
      color: #aaa;
    }

    #estimated_budget .value {
      font-weight: bold;
      display: inline;
    }
    .premier, .percentile-details, #estimated_budget {
      font-size: 12px;
    }
    textarea,
    input[type=text] {
      width: 400px;
    }
    .tapjoy-enabled {
      color: #328F0D;
    }
    .tapjoy-disabled {
      color: #AF1515;
    }
    #percentile {
      font-weight: bold;
    }