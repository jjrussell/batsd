- featured ||= false

- form_for(@offer, :url => { :action => :update }, :html => { :method => :put, :class => 'tjform' }) do |f|
  %table
    %tbody
      %tr
        %th
          = f.label :user_enabled, featured ? 'Enable Featured Installs' : 'Enable Installs'
          #help_user_enabled.help ?
        %td
          = f.check_box :user_enabled
          = error_message_on @offer, :user_enabled
      %tr
        %th
          = f.label :bid, 'Bid'
          #help_bid.help ?
        %td
          = f.currency_field :bid, {}, :class => 'togglable'
          = error_message_on @offer, :bid
          - if featured
            #percentile-info.percentile-details
              This bid will make your offer more prioritized than
              %span#percentile= "#{@offer.estimated_percentile}%" rescue 'N/A'
              of featured offers.
            #percentile-info-loading.percentile-details{ :style => 'display: none' }
              Estimating new featured placement...
            .percentile-details
              The bid is just one of many factors affecting your featured offer ranking.
          - else
            #percentile-info.percentile-details
              This bid places you above approximately
              %span#percentile= "#{@offer.estimated_percentile}%" rescue 'N/A'
              of offers on the offerwall.
            #percentile-info-loading.percentile-details{ :style => 'display: none' }
              Estimating new offerwall placement...
            .percentile-details
              The bid is just one of many factors affecting your offerwall ranking.
            - if !featured && !@offer.on_track_for_budget? && @offer.needs_higher_bid?
              .percentile-details
                To position your app in the top 15% of the offerwall, your bid should be at least 
                %b>= " " + number_to_currency(0.01 * @offer.bid_for_percentile(85))
                \.
      %tr
        %th
          = f.label :payment, 'Payment'
          #help_payment.help ?
        %td
          = f.currency_field :payment, {}, :disabled => 'disabled'
          = error_message_on @offer, :payment
          - if @offer.partner.offer_discounts.active.blank?
            .premier
              Want to reduce your payment?
              = link_to 'Learn more about the Tapjoy Premier Program', premier_path, :tabindex => 97
      %tr
        %th
          Offer Name
          #help_offer_name.help ?
        %td= @offer.name
      %tr
        %th
          = f.label :daily_budget, 'Daily Budget'
          #help_daily.help ?
        %td
          = label_tag :daily_budget_off, 'Unlimited'
          = radio_button_tag('daily_budget', 'off', @offer.daily_budget <= 0, :class => 'togglable')
          &nbsp;
          = label_tag :daily_budget_on, 'Limit'
          = radio_button_tag('daily_budget', 'on', @offer.daily_budget > 0, :class => 'togglable')
          - budget_fields_class = @offer.daily_budget > 0 ? '' : 'hidden'
          #daily_budget_fields{ :class => budget_fields_class }
            = f.label(:daily_budget, 'Installs:')
            = f.text_field(:daily_budget, :class => 'togglable')
            = error_message_on @offer, :daily_budget
            #estimated_budget
              Estimated daily budget:
              .value
      %tr
        %th
          Balance
          #help_balance.help ?
        %td
          = number_to_currency(current_partner.balance / 100.0)
          = link_to 'Add funds', add_funds_billing_path, :class => 'addfunds', :tabindex => 98
      %tr
        %th
          Tapjoy Enabled
          #help_enabled.help ?
        %td
          - if @offer.tapjoy_enabled
            .tapjoy-enabled Enabled
          - else
            .tapjoy-disabled Disabled
      - if @offer.partner.exclusivity_level
        %tr
          %th
            Tapjoy Premier
            #help_premier.help ?
          %td
            = "Member until #{@offer.partner.exclusivity_expires_on.to_s :mdy}"
      - if permitted_to?(:edit, :statz)
        = render('apps/offers_shared/admin_fields', :f => f)
      %tr
        %td{ :colspan => 2 }= f.submit 'Update'
  
.hidden
  #help_offer_name_content{:name => 'Offer Name'}
    Name that will be displayed on offer walls.
  #help_balance_content{:name => 'Balance'}
    Current balance available.
  #help_daily_content{:name => 'Daily Budget'}
    The maximum number of installs per day.
  #help_bid_content{:name => 'Bid'}
    The amount you are willing to pay for an install. A higher bid will result in more traffic. The minimum bid is
    = number_to_currency(0.01 * @offer.min_bid)
  #help_payment_content{:name => 'Payment'}
    The amount that you pay for install. This value is equal to the Bid
    unless you participate in the Tapjoy Premier program, or reach monthly spend figures
  #help_user_enabled_content{:name => 'Enable Installs'}
    Enable installs to get your campaign started.
  #help_enabled_content{:name => 'Tapjoy Enabled'}
    Tapjoy approval status.
    - unless @offer.tapjoy_enabled
      Please contact #{link_to "support@tapjoy.com", "mailto:support@tapjoy.com"} to enable this offer.
  #help_premier_content{:name => 'Tapjoy Premier'}
    When your Tapjoy Premier exclusivity expires.
        
- content_for :page_javascript do
  :plain
    $(function($){
      if (#{!current_partner.is_premier?} && $('#flash_notice').is(':hidden')) {
        $('#flash_notice').html('<b>Notice:</b> #{link_to 'Learn more about the Tapjoy Premier Program', premier_path}').show();
      }

      var toggleUserEnabled = function() {
        if ($('#offer_user_enabled').attr('checked')) {
          $('.togglable').attr('disabled', false);
        } else {
          $('.togglable').attr('disabled', true);
        }
      };

      var setEstimatedBudget = function() {
        checkValidBudget();
        var bid = stringToNumber($('#offer_payment').val());
        var installLimit = stringToNumber($('#offer_daily_budget').val(), true);
        var budget = numberToCurrency(bid * installLimit);
        $('#estimated_budget .value').text(budget);
      };

      var checkValidBudget = function(){
        var installLimit = stringToNumber($('#offer_daily_budget').val(), true);
        if (! (installLimit > 0) ) {
          installLimit = 1;
          $('#offer_daily_budget').val('1');
          alert('Daily install limit must be a number greater than 0. To disable the campaign, please uncheck the box labeled "Enable Installs".');
          return false;
        }
        return true;
      }
      var checkMinimumPrice = function() {
        var minimumPrice = #{([ @offer.bid, @offer.min_bid ].min) / 100.0};
        var currentPrice = stringToNumber($('#offer_bid').val());
        if (currentPrice < minimumPrice) {
          currentPrice = minimumPrice;
        }
        $('#offer_bid').val(numberToCurrency(currentPrice));
        $('#offer_payment').val(numberToCurrency(currentPrice * #{(100.0 - @offer.partner.premier_discount)/100.0}));
      };

      var updatePercentile = function() {
        $.ajax({
          data: { "bid" : $('#offer_bid').val() },
          beforeSend: function() {
            $('#percentile-info').hide();
            $('#percentile-info-loading').show();
          },
          success: function(result) {
            $('#percentile').html(result.percentile + "%");
            $('#percentile-info-loading').hide();
            $('#percentile-info').show();
            $('#percentile').effect('highlight', {}, 1500);
          },
          type: 'post',
          url: '#{percentile_app_offer_url(@app, @offer)}'
        });
      };

      var toggleDailyBudget = function() {
        if ($('#offer_daily_budget').val() == 0) {
          $('#offer_daily_budget').val('');
        }
      };

      toggleUserEnabled();
      $('#offer_user_enabled').change(toggleUserEnabled);

      if ( $('#daily_budget_on').is(':checked') ) {
        setEstimatedBudget();
      }
      $('#offer_bid').change(function() {
        checkMinimumPrice();
        updatePercentile();
      });

      $('#offer_daily_budget').change(function() {
        $(this).val(addCommaSeparators(stringToNumber($(this).val(), true)));
        setEstimatedBudget();
      });
      $('#daily_budget_on').click(function(){
        $('#daily_budget_fields').slideDown();
        toggleDailyBudget();
      });
      $('#daily_budget_off').click(function(){
        $('#daily_budget_fields').slideUp();
        toggleDailyBudget();
      });
      toggleDailyBudget();

      $('form').submit(function() {
        checkMinimumPrice();
        return checkValidBudget();
      });
    });

- content_for :page_styles do
  :plain
    .addfunds {
      padding-left: 15px;
    }
    #estimated_budget .value {
      font-weight: bold;
      display: inline;
    }
    .premier, .percentile-details, #estimated_budget {
      font-size: 12px;
    }
    textarea,
    input[type=text] {
      width: 400px;
    }
    .tapjoy-enabled {
      color: #328F0D;
    }
    .tapjoy-disabled {
      color: #AF1515;
    }
    #percentile {
      font-weight: bold;
    }
    label.narrower, input.narrower {
      width: 140px;
    }

    #offer_status {
    	padding: .8em;
    	margin-bottom: 1em;
    	border: 2px solid #ddd;
    }

    #offer_status.bad { background: #FBB3B4; color: #6a0f01; border-color: #FB8284; }
    #offer_status.mediocre { background: #FFF6BF; color: #514721; border-color: #FFD324; }
    #offer_status.good { background: #E6EFC2; color: #264409; border-color: #C6D880; }

    #offer_status.bad a { color:#6a0f01; }
    #offer_status.mediocre a { color:#514721; }
    #offer_status.good a { color:#264409; }
