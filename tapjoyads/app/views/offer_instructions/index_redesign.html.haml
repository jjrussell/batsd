- @page_title = t('text.instructions.title')
- amount_and_currency = content_tag(:b, t('text.instructions.amount_and_currency', :amount => @currency.get_visual_reward_amount(@offer, params[:display_multiplier]), :currency => @currency.name))
.ui-joy-mask
  .ui-joy-panel#panel
    .grey-box
      .app-logo
        = image_tag @offer.get_icon_url(:source => :cloudfront, :size => '57')
      .heading= @offer.name
    .instructions
      .content
        %ul.steps
          = instruction_list(@offer.instructions).html_safe
    .padit
      .reward-button.click-action
        - if @offer.item_type == 'ActionOffer'
          - if @action_app && @action_app.protocol_handler.present? && @device_type.match(/\A(android|ios|ipad|iphone|itouch)\z/)
            .button-holder
              %input{:value => t('text.instructions.earn_currency_html', :amount_and_currency => amount_and_currency), :type => :button, :id => 'protocol', :class => 'button gradient'}
          - else
            = download_action = link_to(t('text.instructions.earn_currency_html', :amount_and_currency => amount_and_currency), @complete_instruction_url)
        - else
          = link_to(t('text.instructions.earn_currency_html', :amount_and_currency => amount_and_currency), @complete_instruction_url, :class => 'continue')
    #adsby
      %span#presented_by
        = t('text.instructions.presented_by', :default => 'Presented By')
      #logo

- content_for :included_javascripts do
  :javascript
    $(document).ready(function() {
        var isActionOffer = #{@offer.item_type == 'ActionOffer'};
        var hasActionApp = #{@action_app.present?};
        var hasProtocolHandler = #{@action_app.present? ? @action_app.protocol_handler.present? : false};
        if (isActionOffer && hasActionApp && hasProtocolHandler) {
            var timeout;
            var phUrl = #{@action_app.present? ? @action_app.protocol_handler.to_json.html_safe : ""};
            var fallbackUrl = #{@complete_instruction_url.to_json.html_safe},
                  appversion = navigator.appVersion,
                  idevice = (/iphone|ipad|ipod/gi).test(appversion),
                  android = (/android/gi).test(appversion);
            if (idevice) {
                var userAgent = navigator.userAgent.toString().toLowerCase();
                chrome = (/crios/gi).test(userAgent);
                if (!chrome) {
                    $('.button-holder').show();
                }
            } else if (android) {
                $('.button-holder').show();
            }
            $('#protocol').bind('click', function() {
                if (phUrl.length > 0) {
                    if (android) {
                        if (navigator.userAgent.match(/Chrome/)) {
                            setTimeout(function() {
                                if (!document.webkitHidden)
                                    window.location = fallbackUrl;
                            }, 1000);
                            window.location = phUrl;
                        } else {
                            var iframe = document.createElement("iframe");
                            iframe.style.border = "none";
                            iframe.style.width = "1px";
                            iframe.style.height = "1px";
                            iframe.onload = function () { window.location = fallbackUrl; };
                            iframe.src = phUrl;
                            document.body.appendChild(iframe);
                        }
                    } else if (idevice) {
                        timeout = setTimeout(function(){
                            var dataParam = #{params[:data].to_json.html_safe};
                            window.location = (#{app_not_installed_offer_instructions_path.to_json.html_safe} + "?data=" + dataParam);
                        }, 1000);
                        window.location = phUrl;
                        window.addEventListener("pageshow", function() {
                            clearTimeout(timeout);
                            location.reload();
                        });
                    }
                }
            });
        }
    });
