- @page_title = 'Payouts'

%h1 Payouts

%h3
  Payout Freeze Status:
  - if @freeze_enabled
    %span{ :class => 'enabled' } Enabled
  - else
    %span{ :class => 'disabled' } Disabled
  - if permitted_to? :index, :tools_payout_freezes
    = link_to '[modify]', tools_payout_freezes_path

- if @start_date.present?
  %h3
    For partners with payout info modified between
    = @start_date.to_s(:pub)
    and
    = @end_date.to_s(:pub)

#filtered.hidden
  Information updated in:
  = select_date((@start_date || Time.zone.now), :order => [:year, :month], :discard_day => true, :start_year => 2011, :end_year => Time.zone.now.year)
  = submit_tag('Update', :id => :date_submit)
  = submit_tag('Reset', :id => :date_reset)
#unfiltered.hidden
  = link_to 'Filter by payout info modification', '#'
- form_tag(export_tools_payouts_path, :method => :get) do
  = submit_tag('Export to CSV', :id => :export, :action => export_tools_payouts_path)

%table
  %thead
    %tr
      %th Partner
      %th Pending Earnings
      %th Cutoff Date
      %th Payout Amount
      %th Current Payout Created
      %th Payout Info
      %th Action
      %th Confirmed Status
      %th Confirmation Notes
  %tbody
    - @partners.each do |partner|
      - payout_info = partner.payout_info
      - confirmation_notes = partner.confirmation_notes
      - confirmation_notes << 'Payout Info not Present!' unless payout_info.present?
      %tr
        %td
          %strong Name:
          - if payout_info.present?
            = payout_info.company_name
          - else
            \-
          %br/
          %strong Partner Name:
          = partner.name
          - if payout_info.present? && payout_info.doing_business_as.present?
            %br/
            %strong d/b/a:
            = payout_info.doing_business_as
          %br/
          %strong ID:
          = link_to(partner.id, partner_path(partner.id))

        %td= number_to_currency(partner.pending_earnings / 100.0)
        %td= (partner.payout_cutoff_date - 1.day).to_s(:pub)
        %td= number_to_currency(partner.pending_earnings / 100.0 - partner.next_payout_amount / 100.0)
        %td= number_to_currency(partner.next_payout_amount / 100.0)
        - if payout_info.present? && payout_info.valid?
          %td
            %span.present
              %strong Present
            %br/
            %strong Type:
            = payout_info.payout_method
            %br/
            %strong Updated:
            = payout_info.updated_at.to_s(:pub)
        - else
          %td
            %span.not_present
              %strong Not Present
        %td
          - if permitted_to?(:create, :tools_payouts)
            - form_tag tools_payouts_path(:partner_id => partner.id), :method => :post, :class => 'json', :style => 'height:45px;' do
              = text_field_tag 'amount', (partner.next_payout_amount / 100.0), :class => 'amount'
              = submit_tag 'Create Payout', :class => 'submit'
              %img.spinner{ :src => '/images/spinner.gif', :style => 'display:none;' }
              %span.status
          - else
            &nbsp;
        %td
          - if permitted_to?(:confirm_payouts, :tools_payouts)
            - form_tag confirm_payouts_tools_payouts_path( :partner_id => partner.id, :type => :json), :method => :post, :class => 'enable_request' do
              %div{ :class => 'enabled', :style =>  (!confirmation_notes.empty? ? 'display:none;' : 'display:inline;')}
                %span{ :class => 'enabled'}
                  %strong Confirmed
              %div{ :class => 'disabled', :style => (confirmation_notes.empty? ? 'display:none;' : 'display:inline;') }
                %span{ :class => 'disabled'}
                  %strong Unconfirmed
                  = submit_tag 'Confirm', :class => 'submit'
              %img.spinner{ :src => '/images/spinner.gif', :style => 'display:none;' }
          - else
            - if partner.confirmed_for_payout
              %span{ :class => 'enabled'} Confirmed
            - else
              %span{ :class => 'disabled'}
                Uncomfirmed
        %td.notes
          %span{ :class => 'disabled' }
            - unless confirmation_notes.empty?
              \- #{confirmation_notes.join('<br>-')}


%div{ :class => 'popup', :style => 'display:none'}
- content_for :page_javascript do
  :plain
    $(function($) {
      if (#{@start_date.blank?}) {
        $('#unfiltered').show();
      } else {
        $('#filtered').show();
      }
      $('#unfiltered a').click(function(){
        $('#unfiltered').hide();
        $('#filtered').show();
        return false;
      });
      $('#date_submit').click(function(){
        var year = $('select#date_year').val();
        var month = $('select#date_month').val();
        location.href = location.href.split('?')[0] + '?year=' + year + '&month=' + month;
      });
      $('#date_reset').click(function(){
        $('#filtered').hide();
        if (#{@start_date.present?}) {
          location.href = location.href.split('?')[0];
        } else {
          $('#unfiltered').show();
        }
      });

      $('.button-to').submit(function(){
        var form = $(this);
        var button = form.parent();
        var text = button.siblings('.text');
        var spinner = button.siblings('img.spinner');
        var url = form.attr('action');
        $.ajax({
          dataType: 'json',
          type: 'GET',
          url: url,
          data: {},
          beforeSend: function() {
            $('.text').hide('');
            $('.button').show();
            button.hide();
            spinner.show();
          },
          complete: function() {
            spinner.hide();
          },
          success: function(data){
            button.hide();
            var fields = "";
            if (data.payout_method == 'check') {
              fields += "<b>Address</b>: " + data.address_1;
              if (data.address_2) {
                fields += "<br/><b>Address</b>: " + data.address_2;
              }
              fields += "<br/><b>City</b>: " + data.address_city;
              fields += "<br/><b>State</b>: " + data.address_state;
              fields += "<br/><b>Postal/ZIP</b>: " + data.address_postal_code;
              if (data.address_country != "United States Of America") {
                fields += "<br/><b>Country</b>: " + data.address_country;
              }
            } else if (data.payout_method == 'paypal') {
              fields += "<br/><b>Paypal Email</b>: " + data.paypal_email;
            } else {
              fields += "<br/><b>Bank</b>: " + data.bank_name;
              fields += "<br/><b>Bank Address</b>: " + data.bank_address;
              if (data.payment_country == 'United States Of America') {
                fields += "<br/><b>Account #</b>: " + data.bank_account_number;
                fields += "<br/><b>Routing #</b>: " + data.bank_routing_number;
              } else {
                fields += "<br/><b>IBAN</b>: " + data.bank_account_number;
                fields += "<br/><b>SWIFT</b>: " + data.bank_routing_number;
              }
            }
            text.show().html(fields);
          }
        });
        return false;
      });
      $('#date').datepicker();
      $('form.json').submit(function() {
        if (!confirm('Are you sure?')) { return false; }

        var spinner = $(this).find('img.spinner');
        var submit = $(this).find('input.submit');
        var amount = $(this).find('input.amount');
        var status = $(this).find('span.status');

        $.ajax({
          dataType: 'json',
          type: $(this).attr('method'),
          url: $(this).attr('action'),
          data: $(this).serialize(),
          beforeSend: function() {
            amount.hide();
            submit.hide();
            spinner.show();
          },
          complete: function() {
            spinner.hide();
          },
          success: function(response) {
            if (response.success == true) {
              status.html('Complete');
            } else {
              status.html('Error');
            }
          }
        });
        return false;
      });

      $('form.enable_request').submit(function() {
        if (!confirm('Are you sure?')) { return false; }

        var spinner = $(this).find('img.spinner');
        var disabled = $(this).find('div.disabled');
        var enabled = $(this).find('div.enabled');
        var notes = $(this).parent().parent().find('td.notes');

        $.ajax({
          dataType: 'json',
          type: $(this).attr('method'),
          url: $(this).attr('action'),
          data: $(this).serialize(),
          beforeSend: function() {
            disabled.hide();
            enabled.hide();
            spinner.show();
          },
          complete: function() {
            spinner.hide();
          },
          success: function(response) {
            if (response.success == true) {
              if(response.was_confirmed == true) {
                enabled.show();
                notes.empty();
              } else {
                disabled.show();
              }
            } else {
              $(this).parent().html('Error');
            }
          }
        });
        return false;
      });
    });

- content_for :page_styles do
  :plain
    #main {
      width: 1200px;
    }
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid gray;
      padding: 5px;
      font-size: 12px;
    }

    span.enabled, span.present {
      color: green;
    }

    span.disabled, span.not_present {
      color: red;
    }

    h3 a {
      text-decoration: none;
      font-size: 14px;
    }
