- return if objects.blank?
- extra_url_params ||= nil
#selected_app{ :title => "Select your app" }
  - if selected.nil?
    = image_tag('new_app', :size => '24x24', :alt => '')
    Select another app
  - else
    = image_tag(selected.get_icon_url(request.protocol), :size => '24x24', :alt => '')
    = selected.name
#apps_dropdown.hidden
  #search_box
    Search:
    = text_field_tag(:app_name)
  #apps_box
    - objects.each do |o|
      - url = o.class.to_s == 'App' ? app_path(o, extra_url_params) : reporting_path(o, extra_url_params)
      - class_name = o == selected ? "selected" : ""
      .app{ :class => class_name, :title => o.name }
        = image_tag(o.get_icon_url(request.protocol), :size => '24x24', :alt => '')
        %span.app_name= o.name
        = link_to('#', url, :class => "hidden")
  .app{ :class => "new_app #{selected.nil? ? 'selected' : ''}", :title => 'Add a new App' }
    = image_tag('new_app', :size => '24x24', :alt => '')
    Add a new App
    = link_to('#', new_app_path, :class => "hidden")
.clear
- content_for :page_styles do
  :plain
    .hidden {
      display: none;
    }
    #selected_app {
      margin-top: 5px;
      border: 1px solid #888;
      -moz-border-radius: 4px;
      -webkit-border-radius: 4px;
      width: 480px;
      height: 24px;
      vertical-align: middle;
      float: right;
      color: #222;
      font-size: 16px;
      text-decoration: none;
      text-shadow: 0px 1px 1px #fff;
      padding: 7px 0px;
      background: #ddd;
      background: -webkit-gradient(linear, left top, left bottom, color-stop(0.0, #fff), color-stop(0.5, #ddd), color-stop(1.0, #fff));
      background: -moz-linear-gradient(top, #fff, #ddd, #fff);
    }
    #selected_app:hover {
      background: #ccc;
      background: -webkit-gradient(linear, left top, left bottom, color-stop(0.0, #eee), color-stop(0.5, #ccc), color-stop(1.0, #eee));
      background: -moz-linear-gradient(top, #eee, #ccc, #eee);
    }
    #selected_app img, .app img {
      vertical-align: middle;
      margin: 0px 10px;
    }
    .app img {
      margin-left: 5px;
    }
    #search_box {
      padding: 5px 10px;
      height: 24px;
    }
    #apps_dropdown {
      background-color: #eee;
      border: 1px solid #888;
      position: absolute;
      width: 480px;
      padding: 3px 0px;
      -moz-border-radius: 4px;
      -webkit-border-radius: 4px;
    }
    #apps_dropdown #apps_box {
      overflow-y: auto;
      min-height: 34px;
      max-height: 320px;
    }
    .app {
      color: #222;
      text-shadow: 0px 1px 1px #fff;
      overflow-x: hidden;
      white-space: nowrap;
      padding: 5px 5px;
      height: 24px;
    }
    .app.selected {
      background: #337BC8;
      background: -webkit-gradient(linear, left top, left bottom, from(#37ADE0), to(#337BC8));
      background: -moz-linear-gradient(top, #37ADE0, #337BC8);
      color: #fff;
      text-shadow: 0px 1px 1px #6D6C9E;
    }
    .app:hover {
      background: #bbb;
    }
    .app img {
      opacity: 0.75;
    }
    .app:hover img, .app.selected img {
      opacity: 1.0;
    }
    input#app_name {
      width: 360px;
    }
- content_for :page_javascript do
  :plain
    $(function($){
      $('#selected_app').click(function(){

        // scroll to selected app
        $('#apps_dropdown').css({left: -10000, top: -10000}).show();
        var height = $('.app.selected').attr('offsetTop');
        $('#apps_dropdown').scrollTop(height - 2);

        // move div to the proper position
        var offset = $('#selected_app').offset();
        var searchHeight = $('#search_box').outerHeight();
        $('#apps_dropdown').css({ left: offset.left, top: offset.top - searchHeight });
        $('#apps_dropdown input#app_name').focus();
      });

      $('#apps_dropdown .app').not('.selected').click(function(e) {
        $('.app.selected').removeClass('selected');
        $(this).addClass('selected');
        $('#selected_app').html($(this).html());
        location.href = $(this).children('a').attr('href');
      });

      $(document).click(function(e){
        if ($(e.srcElement || e.originalTarget).attr('id') != 'selected_app') {
          $('#apps_dropdown').hide();
        }
      }).keydown(function(e){
        // 27 = escape
        if (e.which == 27) {
          $('#apps_dropdown').hide();
        }
      });

      $('#app_name').keyup(function(e){
        var matchText = $('#app_name').val().toLowerCase().replace(/\W/g, '');
        var visibleApp = null, count = 0;
        $('.app').each(function(){
          var text = $(this).children('span.app_name').text().toLowerCase().replace(/\W/g, '');
          if (!text.match(matchText)) {
            $(this).hide();
          } else {
            $(this).show();
            visibleApp = $(this);
            count++;
          }
        });
        if (e.which == 13 && count == 1) {
          visibleApp.trigger('click');
        }
      });
    });
