- @page_title = 'Partners'

%h1 Partners
- if permitted_to? :new, :partners
  = link_to 'Create a New Partner Account', new_partner_path

- unless current_user.role_symbols.include?(:agency)
  .right
    Managed by:
    - options = options_for_select(@account_managers, params[:id])
    = select_tag('managed_by', options_for_select(options))
    -# partners_path(:mine => true)}
  - form_tag(partners_path, :method => :get, :class => 'tjform') do
    = label_tag(:q, "Name or Email Address:")
    = text_field_tag(:q, params[:q], :size => '40')
    = submit_tag('Search')

%table#partners_table.tablesorter
  %thead
    %tr
      %th Name
      %th Contact
      - if current_user.is_one_of?([:admin, :account_mgr])
        %th Account Manager
      %th Balance
      %th
        Pending
        %br/
        Earnings
      %th{ :class => params[:q].blank? ? 'up_arrow' : '' } Created
      %th Premier
      %th Offers
  %tbody
    - @partners.each do |partner|
      %tr{ :class => cycle('even', 'odd') }
        %td.nowrap= link_to(partner.name || 'Unknown', partner_path(partner))
        %td
          = partner.non_managers.map(&:email).join(', ')
          %br/
          = partner.contact_phone
          %br/
          - form_tag(make_current_partner_path(partner)) do
            - if current_partner == partner
              = submit_tag("Acting as this partner", :class => 'act_as_button', :disabled => true)
            - else
              = submit_tag("Act as this partner", :class => 'act_as_button')
        - if current_user.is_one_of?([:admin, :account_mgr])
          %td.account_manager
            - form_for(partner) do |f|
              - options = options_from_collection_for_select(User.account_managers, "id", "email", partner.account_managers.map(&:id))
              = f.select :account_managers, options, {:include_blank => '(no one)'}
            = image_tag 'load-circle.gif', :class => 'hidden'
            .message.hidden
        %td= number_to_currency(partner.balance / 100.0)
        %td= number_to_currency(partner.pending_earnings / 100.0)
        %td.nowrap= partner.created_at.to_s(:pub)
        %td= partner.is_premier? ? "#{partner.premier_discount}%" : "false"
        %td
          - partner.offers.each do |o|
            .offer
              = image_tag(o.get_icon_url, :size => '20x20')
              = link_to_offer(o)
              - if o.tapjoy_enabled? || o.user_enabled?
                = '(' + (o.tapjoy_enabled? ? 'T' : '') + (o.user_enabled? ? 'U' : '') + ')'

= will_paginate(@partners)

- content_for :page_styles do
  :plain
    table.tablesorter {
      border-collapse: separate;
    }
    table.tablesorter th.up_arrow {
      background-position: 100% 50%;
      background-repeat: no-repeat;
      background-image: url(/stylesheets/themes/blue/asc.gif);
      background-color: #8DBDD8;
    }
    .offer {
      display: inline-block;
      padding-right: 10px;
      padding-top: 5px;
    }
    .nowrap {
      white-space: nowrap;
    }
    .tjform input[type=submit] {
      margin: 0;
      float: none;
    }
    .act_as_button {
      font-size: 10px!important;
      padding:2px!important;
    }
    .agency {
      color: red;
    }
- content_for :page_javascript do
  :plain
    $(function($){
      $('#managed_by').change(function(){
        if ($(this).val() == 'all') {
          location.href = '/partners/';
        } else if ($(this).val() == 'none') {
          location.href = '/partners/managed_by/none';
        } else {
          location.href = '/partners/managed_by/' + $(this).val();
        }
      });
      $('td.account_manager select').change(function(){
        var form = $(this).parent('form');
        var url = form.attr('action');
        var data = {"partner[account_managers]": [$(this).val()]};
        form.siblings('img').show();
        $.ajax({
          data: data,
          error: function() {
            form.siblings('.message').show().text('fail!!!');
            form.siblings('img').hide();
          },
          success: function() {
            form.siblings('.message').show().text('success!');
            form.siblings('img').hide();
          },
          type: 'put',
          url: url
        });
      });
    });
