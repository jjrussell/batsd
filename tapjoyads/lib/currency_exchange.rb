class CurrencyExchange
  OPEN_EXCHANGE_RATES_FREE_API_KEY = 'dca34f06821844669aff8542183c8ec5'
  OPEN_EXCHANGE_RATES_FREE_API_URL = 'http://openexchangerates.org/api'
  USD_DEFAULT_EXCHANGE_RATES = {
      'timestamp' => 1355173208,
      'base' => 'USD',
      'rates' => {
          'AED' => 3.67321,
          'AFN' => 51.3575,
          'ALL' => 108.07875,
          'AMD' => 407.166668,
          'ANG' => 1.78102,
          'AOA' => 95.7876,
          'ARS' => 4.859437,
          'AUD' => 0.953893,
          'AWG' => 1.791167,
          'AZN' => 0.7847,
          'BAM' => 1.513073,
          'BBD' => 2,
          'BDT' => 80.990474,
          'BGN' => 1.509305,
          'BHD' => 0.377014,
          'BIF' => 1524.2025,
          'BMD' => 1,
          'BND' => 1.22049,
          'BOB' => 6.987263,
          'BRL' => 2.085334,
          'BSD' => 1,
          'BTC' => 0.074751,
          'BTN' => 54.4587,
          'BWP' => 7.897845,
          'BYR' => 8617.186667,
          'BZD' => 1.993988,
          'CAD' => 0.988392,
          'CDF' => 931.644836,
          'CHF' => 0.932136,
          'CLF' => 0.020745,
          'CLP' => 476.91936,
          'CNY' => 6.244997,
          'COP' => 1800.28285,
          'CRC' => 499.405099,
          'CUP' => 22.687419,
          'CVE' => 85.510801,
          'CZK' => 19.468587,
          'DJF' => 177.487501,
          'DKK' => 5.752729,
          'DOP' => 40.054191,
          'DZD' => 78.476892,
          'EEK' => 11.760122,
          'EGP' => 6.13421,
          'ETB' => 18.212587,
          'EUR' => 0.770414,
          'FJD' => 1.758208,
          'FKP' => 0.621833,
          'GBP' => 0.621833,
          'GEL' => 1.663675,
          'GHS' => 1.891738,
          'GIP' => 0.624295,
          'GMD' => 30.1503,
          'GNF' => 7136.4875,
          'GTQ' => 7.84815,
          'GYD' => 202.634999,
          'HKD' => 7.750051,
          'HNL' => 19.802404,
          'HRK' => 5.805493,
          'HTG' => 42.129926,
          'HUF' => 218.48095,
          'IDR' => 9625.650924,
          'ILS' => 3.821445,
          'INR' => 54.420068,
          'IQD' => 1163.32,
          'IRR' => 12320.3325,
          'ISK' => 126.75625,
          'JEP' => 0.621833,
          'JMD' => 91.519264,
          'JOD' => 0.709866,
          'JPY' => 82.283552,
          'KES' => 85.940569,
          'KGS' => 47.48,
          'KHR' => 4000.5875,
          'KMF' => 380.406311,
          'KPW' => 900,
          'KRW' => 1079.742734,
          'KWD' => 0.281454,
          'KYD' => 0.822785,
          'KZT' => 150.300946,
          'LAK' => 7986.852451,
          'LBP' => 1508.30988,
          'LKR' => 128.676564,
          'LRD' => 73,
          'LSL' => 8.6764,
          'LTL' => 2.66234,
          'LVL' => 0.537017,
          'LYD' => 1.258825,
          'MAD' => 8.566283,
          'MDL' => 12.279787,
          'MGA' => 2266.13,
          'MKD' => 47.232066,
          'MMK' => 852.70625,
          'MNT' => 1400.5,
          'MOP' => 7.978963,
          'MRO' => 298.956253,
          'MUR' => 30.924132,
          'MVR' => 15.3643,
          'MWK' => 329.230002,
          'MXN' => 12.846051,
          'MYR' => 3.055352,
          'MZN' => 29.575467,
          'NAD' => 8.701257,
          'NGN' => 156.986967,
          'NIO' => 24.041859,
          'NOK' => 5.662318,
          'NPR' => 87.255412,
          'NZD' => 1.202535,
          'OMR' => 0.385018,
          'PAB' => 1,
          'PEN' => 2.57508,
          'PGK' => 2.07559,
          'PHP' => 40.927852,
          'PKR' => 96.874411,
          'PLN' => 3.175595,
          'PYG' => 4371.799218,
          'QAR' => 3.640796,
          'RON' => 3.49466,
          'RSD' => 87.838986,
          'RUB' => 30.816638,
          'RWF' => 623.736289,
          'SAR' => 3.750111,
          'SBD' => 7.090847,
          'SCR' => 13.060643,
          'SDG' => 4.413667,
          'SEK' => 6.671042,
          'SGD' => 1.220718,
          'SHP' => 0.621833,
          'SLL' => 4332.751083,
          'SOS' => 1613.46,
          'SRD' => 3.28125,
          'STD' => 18970.972305,
          'SVC' => 8.744726,
          'SYP' => 70.9648,
          'SZL' => 8.676338,
          'THB' => 30.648709,
          'TJS' => 4.766867,
          'TMT' => 2.85025,
          'TND' => 1.57558,
          'TOP' => 1.742264,
          'TRY' => 1.78825,
          'TTD' => 6.390786,
          'TWD' => 29.076683,
          'TZS' => 1600.98482,
          'UAH' => 8.140584,
          'UGX' => 2691.93903,
          'USD' => 1,
          'UYU' => 19.352609,
          'UZS' => 1972.035316,
          'VEF' => 4.294858,
          'VND' => 20827.77666,
          'VUV' => 91.016666,
          'WST' => 2.29035,
          'XAF' => 507.395076,
          'XCD' => 2.7019,
          'XDR' => 0.65245,
          'XOF' => 507.360002,
          'XPF' => 92.418226,
          'YER' => 214.926505,
          'ZAR' => 8.692101,
          'ZMK' => 5278.577578,
          'ZWL' => 322.322775
      }
  }

  def self.convert_usd_to_foreign(amount, currency_symbol_str)
    rate = usd_exchange_rates['rates'][currency_symbol_str]
    (amount.to_f * rate.to_f).round(2)
  end

  def self.convert_foreign_to_usd(amount, currency_symbol_str)
    if rate = usd_exchange_rates['rates'][currency_symbol_str]
      (amount.to_f / rate.to_f).round(2)
    else
      0.0
    end
  end

  def self.usd_exchange_rates
    @usd_latest_exchange_rates || USD_DEFAULT_EXCHANGE_RATES
  end

  def self.usd_latest_exchange_rates
    @usd_latest_exchange_rates || get_usd_latest_exchange_rates
  end

  private

  def self.get_usd_latest_exchange_rates
    unless defined? @usd_latest_exchange_rates
      response = request(OPEN_EXCHANGE_RATES_FREE_API_URL + "/latest.json?app_id=#{OPEN_EXCHANGE_RATES_FREE_API_KEY}")
      @usd_latest_exchange_rates = JSON.parse(response.body) if response.status == 200
    end
  rescue JSON::ParserError
  end

  def self.request(url, params={}, data=nil)
    unless params.empty?
      url += "?" + params.map { |k, v| [ k, CGI::escape(v) ].join('=') }.join('&')
    end
    options = { :return_response => true, :timeout => 30 }
    if data.present?
      Downloader.post(url, data, options)
    else
      Downloader.get(url, options)
    end
  end
end
