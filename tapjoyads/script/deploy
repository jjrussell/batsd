#!/usr/bin/env ruby

require 'yaml'

if ARGV.first == 'production'
  puts "PRODUCTION deploy"
  server_list = `script/ec2servers mc`.split("\n")
  rails_mode = 'production'
else
  puts "TESTING deploy"
  server_list = `script/ec2servers testserver`.split("\n")
  rails_mode = 'test'
end

puts "Servers to push to:"
puts server_list

version_number = ARGV[1]

unless version_number
  settings = YAML::load_file('server/configuration.yaml')
  version_number = settings['config']['deploy_version']
end

puts "\nUpdating local svn"
puts `svn update`
print "Deploy version #{version_number}? [y/N] "
answer = STDIN.gets
if !/^y/i.match(answer)
  exit
end

server_list.each do |s|
  puts "Deploying on #{s}"
  
  puts `ssh webuser@#{s} 'cd server && svn update && ./deploy.rb #{version_number}'`
  
  puts "Done deploying on #{s}\n\n"
end

puts "Done deploying"