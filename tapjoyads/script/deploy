#!/usr/bin/env ruby

include Ec2Helper

if ARGV.first == 'production'
  puts "PRODUCTION deploy"
  server_list = get_dns_names('jobserver') | get_dns_names('webserver')
  rails_mode = 'production'
else
  puts "TESTING deploy"
  server_list = get_dns_names('testserver')
  rails_mode = 'test'
end

puts "Servers to push to:"
puts server_list

puts "\nUpdating local svn"
puts `svn update`
svn_info = `svn info`
svn_rev = svn_info.match(/\nRevision: (\d*)/)[1]
print "Deploy revision #{svn_rev}? [y/N] "
answer = STDIN.gets
if !/^y/i.match(answer)
  exit
end

server_list.each do |s|
  puts "Deploying on #{s}"
  
  puts "Updating svn"
  puts `ssh webuser@#{s} 'cd tapjoyads && svn update'`
  
  puts "Restarting services"
  puts `ssh webuser@#{s} 'cd tapjoyads && script/restart #{rails_mode}'`
  
  puts "Done deploying on #{s}\n\n"
end

puts "Done deploying"