#!/usr/bin/env ruby

prod_server_list = [
  'ec2-75-101-247-213.compute-1.amazonaws.com',
  'ec2-174-129-66-251.compute-1.amazonaws.com'
  ]
  
test_server_list = [
  'ec2-67-202-31-220.compute-1.amazonaws.com'
  ]

if ARGV.first == 'production'
  puts "PRODUCTION deploy"
  server_list = prod_server_list
  rails_mode = 'production'
else
  puts "TESTING deploy"
  server_list = test_server_list
  rails_mode - 'test'
end

puts 'Updating svn'
puts `svn update`
svn_info = `svn info`
svn_rev = svn_info.match(/\nRevision: (\d*)/)[1]
print "Deploy revision #{svn_rev}? [y/N] "
answer = gets
if !/^y/i.match(answer)
  exit
end

server_list.each do |s|
  puts "Deploying on #{s}"
  
  puts "Updating svn"
  puts `ssh webuser@#{s} 'cd tapjoyads && svn update'`
  
  puts "Restarting services"
  puts `ssh webuser@#{s} 'cd tapjoyads && script/restart #{rails_mode}'`
  
  puts "Done deploying on #{s}\n\n"
end

puts "Done deploying"