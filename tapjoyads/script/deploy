#!/usr/bin/env ruby

require 'yaml'
require 'optparse'

class Deploy

  VERSION_FILENAME = '../server/version.yaml'

  def initialize(args)
    @options = {
      :environment   => 'test',
      :server_groups => 'testserver',
      :cherry_picked => false
    }

    option_parser = OptionParser.new do |opts|
      opts.on('-e', '--environment [ENVIRONMENT]') do |environment|
        if environment == 'production'
          @options[:environment] = 'production'
          @options[:server_groups] = 'masterjobs jobserver dashboard webserver'
        elsif environment == 'util'
          @options[:environment] = 'util'
          @options[:server_groups] = 'util'
        elsif environment != 'test'
          print_usage_and_exit
        end
      end

      opts.on('-c', '--cherry-pick') do
        @options[:cherry_picked] = true
      end

      opts.on('-v', '--version [VERSION]') do |version|
        @options[:version] = version
      end

      opts.on('--skip-schema-check') do
        @options[:skip_schema_check] = true
      end

      opts.on_tail('-h', '--help') do
        print_usage_and_exit
      end
    end

    unless option_parser.parse!(args).empty?
      puts "Unknown options given."
      print_usage_and_exit
    end

    if @options[:environment] == 'production' && !@options[:version].nil? && @options[:version] !~ /^[0-9]+$/
      puts "invalid version for production deploy, must be a version number"
      print_usage_and_exit
    end
    @options[:version] = 'master' if (@options[:environment] == 'test' || @options[:environment] == 'util') && @options[:version].nil?
  end

  def deploy
    puts "#{@options[:environment].upcase} deploy"
    update_working_copy
    if @options[:version].nil?
      check_syntax
      create_deploy_tag
    end
    check_schema if @options[:environment] == 'production' && !@options[:skip_schema_check]
    system("script/record_deploy -e #{@options[:environment]} -v #{@options[:version]}") if execute_cloudrun
    system("bundle exec rake airbrake:deploy TO=#{@options[:environment]} REVISION=#{@options[:version]} USER=#{ENV['USER']} REPO=git://github.com/Tapjoy/tapjoyserver")
    system("git checkout master")
    puts "Done deploying: #{Time.now}"
  end

  private

  def print_usage_and_exit
    puts "USAGE: script/deploy [options]"
    puts "    -e, --environment (optional): The environment to deploy to. Can be 'test', 'util', or 'production'. Default is 'test'."
    puts "    -c, --cherry-pick (optional): If you've already cherry-picked the changes, deploy won't auto-merge master in."
    puts "    -v, --version (optional): The version to deploy. Defaults to 'master' for test and util deploys, creates a new tag for production deploys."
    exit
  end

  def prompt_and_exit_if_not_yes
    answer = STDIN.gets
    if answer !~ /^(y|yes)$/i
      exit 1
    end
  end

  def check_syntax
    unless system("rails runner 'Utils.check_syntax'")
      puts "Syntax Check: FAILED"
      exit 1
    end
    puts "Syntax Check: PASSED"
  end
  
  def check_schema
    system("rake DATABASE=production_slave db:schema:dump_database")
    if `git status` =~ /db\/schema.rb/
      puts "Schema Check: FAILED"
      puts "db/schema.rb file is incorrect - make sure migrations have been run and that db/schema.rb is correct"
      exit 1
    end
    puts "Schema Check: PASSED"
  end

  def update_working_copy
    puts "Updating working copy"
    git_status = `git status`
    if git_status !~ /working directory clean/
      puts "You must have a clean working directory!"
      exit 1
    end

    system('git checkout master')
    if git_status !~ /On branch master/
      puts "Couldn't checkout master!"
      exit 1
    end
    system("git pull tapjoy master")

    unless @options[:version] == 'master'
      system('git checkout deploy')
      git_status = `git status`
      if git_status !~ /On branch deploy/
        puts "Couldn't checkout deploy!"
        exit 1
      end
      system("git pull tapjoy deploy")

      unless @options[:cherry_picked]
        system('git merge master')
      end
    end
  end

  def create_deploy_tag
    yaml_version = YAML::load_file(VERSION_FILENAME)
    @options[:version] = (yaml_version['current'].to_i + 1).to_s

    print "No deploy tag specified. Create new deploy tag #{@options[:version]}? [y/N] "
    prompt_and_exit_if_not_yes

    puts "Updating webserver.sqlite file."
    unless system("rails runner 'Utils.update_sqlite_schema' > /dev/null")
      puts "Failed to update webserver.sqlite!"
      exit 1
    end
    system("git add db/webserver.sqlite")

    puts "Incrementing version file."
    yaml_version['current'] = @options[:version]
    File.open(VERSION_FILENAME, 'w') do |f|
      f.write(yaml_version.to_yaml)
    end
    system("git add #{VERSION_FILENAME}")
    system("git commit -m 'Incrementing version number to #{@options[:version]}'")

    puts "Creating new deploy tag."
    system("git tag -a -m 'Creating deploy tag #{@options[:version]}' #{@options[:version]}")

    puts "Pushing new version."
    system("git push --tags tapjoy deploy")

    puts "Notifying developers on pull requests just tagged."
    system("script/notify_deploy -e production")
  end

  def execute_cloudrun
    command = "script/cloudrun '#{@options[:server_groups]}' 'cd /home/webuser/tapjoyserver && server/deploy.rb #{@options[:version]}' 'webuser'"
    system(command)
  end

end

Deploy.new(ARGV).deploy
