#!/usr/bin/env ruby

require 'yaml'

if ARGV.first == 'production'
  puts "PRODUCTION deploy"
  group = 'mc'
else
  puts "TESTING deploy"
  group = 'testserver'
end

puts "\nUpdating local svn"
puts `svn update`

version_number = ARGV[1]

unless version_number
  settings = YAML::load_file('server/configuration.yaml')
  version_number = settings['config']['deploy_version']
end

# Must use the system command to run, not backticks, otherwise it will be non-interactive.
system("script/cloudrun #{group} 'cd server && svn update && ./deploy.rb #{version_number}'")

puts "Done deploying"